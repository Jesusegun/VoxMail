<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AI Email Digest</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8fafc;
            color: #1f2937;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: white;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 24px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #7c3aed;
            margin-bottom: 8px;
        }
        .stat-label {
            color: #6b7280;
            font-size: 14px;
        }
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .panel-header {
            background-color: #f9fafb;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            color: #374151;
        }
        .panel-content {
            padding: 20px;
        }
        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .user-item:last-child {
            border-bottom: none;
        }
        .user-info {
            flex-grow: 1;
        }
        .user-email {
            font-weight: 600;
            color: #1f2937;
        }
        .user-meta {
            font-size: 12px;
            color: #6b7280;
        }
        .user-actions {
            display: flex;
            gap: 8px;
        }
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        .btn-success {
            background-color: #059669;
            color: white;
        }
        .btn-warning {
            background-color: #d97706;
            color: white;
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 14px;
        }
        .activity-icon.digest { background-color: #dbeafe; color: #2563eb; }
        .activity-icon.error { background-color: #fee2e2; color: #dc2626; }
        .activity-icon.user { background-color: #d1fae5; color: #059669; }
        .activity-text {
            flex-grow: 1;
            font-size: 14px;
        }
        .activity-time {
            font-size: 12px;
            color: #6b7280;
        }
        .system-health {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .health-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 6px;
            background-color: #f9fafb;
        }
        .health-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }
        .status-good { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-error { background-color: #ef4444; }
        @media (max-width: 768px) {
            .content-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë®‚Äçüíº Admin Dashboard</h1>
            <p>System overview and user management</p>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_users }}</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.active_users_today }}</div>
                <div class="stat-label">Active Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.digests_sent_today }}</div>
                <div class="stat-label">Digests Sent Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_emails_processed }}</div>
                <div class="stat-label">Emails Processed</div>
            </div>
        </div>

        <div class="content-grid">
            <!-- User Management -->
            <div class="panel">
                <div class="panel-header">
                    üë• User Management ({{ users|length }} users)
                </div>
                <div class="panel-content">
                    <div class="user-list">
                        {% for user in users %}
                        <div class="user-item">
                            <div class="user-info">
                                <div class="user-email">{{ user.email }}</div>
                                <div class="user-meta">
                                    ID: {{ user.id }} | 
                                    Digest: {{ '%02d:00'|format(user.digest_time) }} {{ user.timezone }} |
                                    {% if user.vacation_mode %}üèñÔ∏è Vacation{% else %}Active{% endif %}
                                </div>
                            </div>
                            <div class="user-actions">
                                <a href="/user_settings/{{ user.id }}" class="btn btn-primary">‚öôÔ∏è Settings</a>
                                <a href="/generate_digest/{{ user.id }}" class="btn btn-success">üìß Test Digest</a>
                                <a href="/admin/reset_user/{{ user.id }}" class="btn btn-warning" 
                                   onclick="return confirm('Reset AI learning for {{ user.email }}?')">üîÑ Reset</a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div style="margin-top: 16px; text-align: center;">
                        <a href="/oauth_login" class="btn btn-success">üîê Add User via OAuth</a>
                        <a href="/bulk_actions" class="btn btn-primary">üìã Bulk Actions</a>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                            Users authenticate through Google Cloud OAuth
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="panel">
                <div class="panel-header">
                    üìä Recent Activity
                </div>
                <div class="panel-content">
                    <div style="max-height: 400px; overflow-y: auto;">
                        {% for activity in recent_activity %}
                        <div class="activity-item">
                            <div class="activity-icon {{ activity.type }}">
                                {% if activity.type == 'digest' %}üìß
                                {% elif activity.type == 'error' %}‚ö†Ô∏è
                                {% elif activity.type == 'user' %}üë§
                                {% else %}üìù{% endif %}
                            </div>
                            <div class="activity-text">
                                <strong>{{ activity.description }}</strong><br>
                                <span style="color: #6b7280; font-size: 12px;">{{ activity.details }}</span>
                            </div>
                            <div class="activity-time">{{ activity.timestamp }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div style="margin-top: 16px; text-align: center;">
                        <a href="/admin/full_logs" class="btn btn-primary">üìã View Full Logs</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Health -->
        <div class="panel" style="margin-top: 24px;">
            <div class="panel-header">
                üîß System Health
            </div>
            <div class="panel-content">
                <div class="system-health">
                    <div class="health-item">
                        <span>AI Processing</span>
                        <div class="health-status {{ 'status-good' if system_health.ai_processing else 'status-error' }}"></div>
                    </div>
                    <div class="health-item">
                        <span>Gmail API</span>
                        <div class="health-status {{ 'status-good' if system_health.gmail_api else 'status-error' }}"></div>
                    </div>
                    <div class="health-item">
                        <span>Email Sending</span>
                        <div class="health-status {{ 'status-good' if system_health.email_sending else 'status-error' }}"></div>
                    </div>
                    <div class="health-item">
                        <span>Storage</span>
                        <div class="health-status {{ 'status-good' if system_health.storage else 'status-warning' }}"></div>
                    </div>
                </div>
                
                <div style="margin-top: 16px; text-align: center;">
                    <a href="/admin/system_check" class="btn btn-primary">üîç Run System Check</a>
                    <a href="/admin/diagnostics" class="btn btn-warning">ü©∫ Diagnostics</a>
                    <a href="/admin/backup" class="btn btn-success">üíæ Backup Data</a>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div style="margin-top: 24px; text-align: center;">
            <a href="/admin/send_all_digests" class="btn btn-success" 
               onclick="return confirm('Send digests to all active users now?')">üìß Send All Digests</a>
            <a href="/admin/system_maintenance" class="btn btn-warning">üîß Maintenance Mode</a>
            <a href="/" class="btn btn-primary">‚Ü©Ô∏è Back to Main</a>
        </div>
    </div>
</body>
</html>
